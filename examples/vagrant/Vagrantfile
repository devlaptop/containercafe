# -*- mode: ruby -*-
# vi: set ft=ruby :

# Vagrantfile API/syntax version. Don't touch unless you know what you're doing!
VAGRANTFILE_API_VERSION = "2"

$install_ansible = <<SCRIPT
apt-add-repository ppa:ansible/ansible-1.9
apt-get -qq update
apt-get -qq -y install ansible
SCRIPT

$install_docker = <<SCRIPT
apt-get -qq update
apt-get -qq -y install apt-transport-https ca-certificates
apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D
echo "deb https://apt.dockerproject.org/repo ubuntu-trusty main" > /etc/apt/sources.list.d/docker.list
apt-get -qq update
apt-get -qq -y install linux-image-extra-$(uname -r) apparmor docker-engine
usermod -aG docker vagrant
SCRIPT

Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  config.vm.box = "ubuntu/trusty64"
  config.ssh.insert_key = false
    
  (1..2).each do |i|
    config.vm.define "radiant#{i+1}" do |node|
      node.vm.network "private_network", ip: "192.168.10.#{i+1}"
      node.vm.hostname = "radiant#{i+1}"
    
      node.vm.provider "virtualbox" do |nodeopts|
        nodeopts.name = "radiant#{i+1}"
        nodeopts.memory = 1536
        nodeopts.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
        nodeopts.customize ["modifyvm", :id, "--natdnsproxy1", "on"]
      end
    end
  end
  
  ['ansible', 'example'].each do |name|
    config.vm.define name, autostart: false do |ansible|
      ansible.vm.network "private_network", ip: "192.168.9.253"
      ansible.vm.synced_folder ".", "/vagrant", disabled: true
      ansible.vm.synced_folder "../../ansible", "/vagrant/synced_ansible", mount_options: ["dmode=775,fmode=664"]
      ansible.vm.synced_folder "../../crawler", "/vagrant/crawler", mount_options: ["dmode=775,fmode=664"]
      ansible.vm.synced_folder "../../misc", "/vagrant/misc", mount_options: ["dmode=775,fmode=664"]
      ansible.vm.synced_folder "../../proxy", "/vagrant/proxy", mount_options: ["dmode=775,fmode=664"]
      ansible.vm.synced_folder "../../remoteabac", "/vagrant/remoteabac", mount_options: ["dmode=775,fmode=664"]
      ansible.vm.synced_folder "../envs", "/vagrant/examples/envs", mount_options: ["dmode=775,fmode=664"]
    
      # Ansible fails on Windows when writes on a synced folder 
      # (see https://github.com/ansible/ansible/issues/9526#issuecomment-199443969)
      ansible.vm.provision "shell", inline: "cp -rp /vagrant/synced_ansible /vagrant/ansible"
    
      ansible.vm.provision "file", source: "~/.vagrant.d/insecure_private_key", destination: "/home/vagrant/.vagrant.d/insecure_private_key"
      ansible.vm.provision "shell", inline: "chmod 600 /home/vagrant/.vagrant.d/insecure_private_key"
      ansible.vm.provision "shell", inline: $install_ansible
      ansible.vm.provision "shell", privileged: false, inline: "source ~/.profile && [ -z \"$ANSIBLE_INVENTORY\" ] && echo \"export ANSIBLE_INVENTORY=/vagrant/examples/envs/dev-vbox/radiant01.hosts\" >> ~/.profile"
      ansible.vm.provision "shell", privileged: false, inline: "source ~/.profile && [ -z \"$ANSIBLE_LIBRARY\" ] && echo \"export ANSIBLE_LIBRARY=$ANSIBLE_INVENTORY\" >> ~/.profile"
    
      if name == 'example'
        ansible.vm.provision "shell", privileged: false, inline: "cd /vagrant/ansible && ansible-playbook -v shard.yml -e cluster_name=dev-vbox-radiant01 -e network_kind=bridge"
        ansible.vm.provision "shell", inline: "cp -rf /vagrant/ansible/certs /vagrant/synced_ansible"
      end
    
      ansible.vm.provider "virtualbox" do |virtualbox|
        virtualbox.name = name
      end
    end
  end
  
  config.vm.define 'proxy', autostart: false do |proxy|
    proxy.vm.network "private_network", ip: "192.168.9.252"
    proxy.vm.synced_folder ".", "/vagrant", disabled: true
    proxy.vm.synced_folder "../../ansible", "/vagrant/ansible", mount_options: ["dmode=775,fmode=664"]
    proxy.vm.synced_folder "../../proxy", "/vagrant/proxy", mount_options: ["dmode=775,fmode=764"]
    
    proxy.vm.provision "shell", inline: $install_docker
    proxy.vm.provision "shell", inline: "cd /vagrant/proxy && ./builddocker.sh && ./rundocker.sh -d"
    proxy.vm.provision "shell", privileged: false, inline: "ln -s /vagrant/proxy"
    
    proxy.vm.provider "virtualbox" do |virtualbox|
      virtualbox.name = "hjproxy"
    end
  end
end
